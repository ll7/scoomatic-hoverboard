var OBNFormLocker=function(){this.isFormLocked=false;this.eventObjQueue=[];this.queueActualSize=0;this.getOldestEventObjectCopy=function(){var a=undefined;if(this.eventObjQueue.length){a=this.eventObjQueue[this.queueActualSize];if(++this.queueActualSize*2>=this.eventObjQueue.length){this.eventObjQueue=this.eventObjQueue.slice(this.queueActualSize);this.queueActualSize=0}}return a};this.insertNewEventObjectCopy=function(a){this.eventObjQueue.push(a)}};var callOnObjNav=function(){var a=obnFormLocker.getOldestEventObjectCopy();if(a!="undefined"&&a!=null){onObjBasedNavigate(a)}};function onOBNIFrameLoad(){obnFormLocker.isFormLocked=false;callOnObjNav()}function onObjBasedNavigate(f){if(obnInspector.isEnabled()){var e=obnInspector.handleDoObjInspection(f);if(e){return}}if(obnFormLocker.isFormLocked==true){obnFormLocker.insertNewEventObjectCopy(f);return}obnFormLocker.isFormLocked=true;var b=document.getElementById("obnNavForm");b.operation.value=getOperation(f.dataObject.operation);b.systemAlias.value=f.dataObject.systemAlias;b.businessObjName.value=f.dataObject.businessObjName;b.objValue.value=f.dataObject.objValue;b.resolvingMode.value=getResolvingMode(f.dataObject.resolvingMode);b.source.value=getOriginalNavTarget();var g=f.dataObject.postBody;if(g!=null&&typeof(g)=="object"){b.usePost.value="true";var j=b.innerHTML;var k=j;for(var c=0;c<g.length;c++){if(g[c]!=undefined){var d=ESCAPE_TO_HTML(g[c].name);var a=ESCAPE_TO_HTML(g[c].value);var h="<input type=hidden name='"+d+"' id='"+d+"' value='"+a+"'></input>\n";j+=h}}b.innerHTML=j}else{b.usePost.value="false"}b.submit();if(g!=null&&typeof(g)=="object"){b.innerHTML=k}}function OBNInspector(){var b=null;this.isEnabled=function(){return this.getInspectionMode()!=0};this.getiViewURL=function(){if(b==null){var c=parseQueryString(window.location.href);for(var d=0;d<c.length;d++){var e=c[d];var f=e.key;if(f=="sap-obn-sourceiviewurl"){b=e.value;break}}}return b};this.getInspectionMode=function(){var c=getIsMashupPage();if(c){return 1}var d=this.getiViewURL();if(d!=null){return 2}return 0};this.handleDoObjInspection=function(o){var d=o.dataObject.businessObjName;var e=o.dataObject.systemAlias;var l=getOperation(o.dataObject.operation);var n=getResolvingMode(o.dataObject.resolvingMode);var m=null;if(o.dataObject.objValue!="undefined"&&o.dataObject.objValue!=""){var k=decodeURIComponent(o.dataObject.objValue);m=parseQueryString(k)}var q=null;var f=o.dataObject.postBody;if(f!=null&&typeof(f)=="object"){q=parsePostBodyParams(f)}var g=new Array();if(m!=null){for(var h=0;h<m.length;h++){var c=m[h];g.push(c)}}if(q!=null){for(var h=0;h<q.length;h++){var c=q[h];g.push(c)}}g.push({key:"obn.ResolvingScope",value:n});if(obnInspector.getInspectionMode()==1){var j=generateOBNUrlByOBNMetadata(d,e,l,g,false);var p=fireMashupEvent(j,g);if(!p){return false}}if(obnInspector.getInspectionMode()==2){g.push({key:"iViewURL",value:b});var j=generateOBNUrlByOBNMetadata(d,e,l,g,true);EPCM.raiseEvent("urn:com.sapportals.portal:childToParents","RegisterOBNLink",j)}return true};this.handleDoNavInspection=function(k){var d=k.dataObject.target;if(d.indexOf("OBN://")==-1){a(k)}var n=parseQueryString(d);var m=null;var e=k.dataObject.postBody;if(e!=null&&typeof(e)=="object"){m=parsePostBodyParams(e)}var j;var h=d.indexOf("?");if(h>0){j=d.substring(0,h)}else{j=d}var o=false;var f=new Array();if(objValueParams!=null){for(var g=0;g<objValueParams.length;g++){var c=objValueParams[g];f.push(c);if(parmObj.key=="obn.ResolvingScope"){o=true}}}if(m!=null){for(var g=0;g<m.length;g++){var c=m[g];f.push(c);if(parmObj.key=="obn.ResolvingScope"){o=true}}}if(!o){f.push({key:"obn.ResolvingScope",value:"default"})}if(obnInspector.getInspectionMode()==1){var j=generateOBNUrlByOBNMetadata(j,false);var l=fireMashupEvent(j,f);if(!l){a(k)}}if(obnInspector.getInspectionMode()==2){f.push({key:"iViewURL",value:b});var j=generateOBNUrlByOBNMetadata(j,true);EPCM.raiseEvent("urn:com.sapportals.portal:childToParents","RegisterOBNLink",j)}};this.handleInspectionModeTermination=function(c){window.close()};var a=function(c){EPCM.raiseEvent("urn:com.sapportals:navigation","overrideNavigationFailover",c.dataObject)}}function getIsMashupPage(){return EPCM.isSubscribed("com.sap.portal.mashup","mashSourceEvent")}function fireMashupEvent(f,h){var e=EPCM.getSAPTop().MashupAPI;if(e){var b=JSUtils.MD5(f);var a=e.isConnected(b);if(a){var g=e.getEventData();g.addData("portId",b);for(var c=0;c<h.length;c++){var d=h[c];if(d.key!="obn.ResolvingScope"){g.addData(d.key,d.value)}}EPCM.raiseEvent("com.sap.portal.mashup","mashSourceEvent",g.toString());return true}}return false}function paramObjComparator(b,a){if(b.key<a.key){return -1}else{if(a.key<b.key){return 1}else{return 0}}}function generateOBNUrlByOBNUrl(a,c,b){var d=new Array();d.push(a);return generateOBNURLInternal(d,c,b)}function generateOBNUrlByOBNMetadata(b,a,f,d,c){var e=new Array();e.push("OBN://BOTechnicalName=");e.push(b);if(f!=""){e.push("/Operation=");e.push(f)}if(a!=""){e.push("/BOSystemAlias=");e.push(a)}return generateOBNURLInternal(e,d,c)}function generateOBNURLInternal(a,f,d){f.sort(paramObjComparator);for(var b=0;b<f.length;b++){if(b==0){a.push("?")}else{a.push("&")}var c=f[b];a.push(encodeURIComponent(c.key));a.push("=");if(d||c.key=="obn.ResolvingScope"){a.push(encodeURIComponent(c.value))}}var e=a.join("");return e}function parseQueryString(k){var e=new Array();var h=k.indexOf("?");if(h>0){k=k.substring(h+1)}var b=k.split("&");for(var l=0;l<b.length;l++){var g=b[l].split("=");var m=decodeURIComponent(g[0]);var c=decodeURIComponent(g[1]);if(m=="DynamicParameter"){var d=parseQueryString(c);for(var f=0;f<d.length;f++){var a=d[f];e.push(a)}}else{var a={key:m,value:c};e.push(a)}}return e}function parsePostBodyParams(e){var f=new Array();for(var c=0;c<obnPostBody.length;c++){var g=e[c].name;var h=e[c].value;if(g=="DynamicParameter"){var a=parseQueryString(h);for(var b=0;b<a.length;b++){var d=a[b];params.push(d)}}else{var d={key:g,value:h};f.push(d)}}return f}function appendOBNUrlParam(b){var a="";if(b&&b.indexOf("OBN://")==0){a="&sap-obn-url="+encodeURIComponent(b)}return a}function getResolvingMode(a){if(typeof(a)!="undefined"&&a!=null){return a.toLowerCase()}else{return"default"}}function getOperation(a){if(typeof(a)!="undefined"&&a!=null){return a}else{return""}}function getOriginalNavTarget(){try{return EPCM.getSAPTop().gHistoryFrameworkObj.GetActiveTrackingEntryValue().URL}catch(a){return""}}var obnFormLocker;var obnInspector;function initOBN(){obnFormLocker=new OBNFormLocker();obnInspector=new OBNInspector();var a=document.getElementById("obnNavIFrame");if(a.attachEvent){a.attachEvent("onload",onOBNIFrameLoad)}else{a.onload=onOBNIFrameLoad}EPCM.subscribeEvent("urn:com.sapportals:navigation","ObjBasedNavigate",onObjBasedNavigate);if(obnInspector.isEnabled()){EPCM.subscribeEvent("urn:com.sapportals:navigation","OverrideNavigation",obnInspector.handleDoNavInspection)}}EPCM.subscribeEventReliable("urn:com.sapportals.portal:browser","load",initOBN);